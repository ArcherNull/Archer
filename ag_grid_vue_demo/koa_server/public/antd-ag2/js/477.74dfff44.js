"use strict";(self["webpackChunkAG"]=self["webpackChunkAG"]||[]).push([[477],{5477:function(e,t,a){a.r(t),a.d(t,{default:function(){return v}});var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("BLModal",{attrs:{title:(e.editId?"编辑":"新增")+"电子围栏",dialogStyle:{top:"50px",paddingBottom:"0px"},bodyStyle:{padding:"10px 16px",maxHeight:"calc(100vh - 180px)",overflowY:"scroll"},visible:e.visible},on:{cancel:e.handleCancel}},[a("div",{staticClass:"AddFenceDialog-content"},[a("BMapFence",{ref:"BMapFenceRef",on:{postMessage:e.postMessage}}),e.addFenceType?a("a-card",{staticClass:"AddFenceDialog-content-form",attrs:{bodyStyle:{padding:"6px 16px"}}},[a("h3",[e._v("新增围栏："+e._s("circle"===e.addFenceType?"圆":"多边形"))]),a("a-form",{attrs:{form:e.form,name:"AddFenceForm",layout:"vertical"}},[a("a-form-item",{attrs:{label:"围栏名称"}},[a("a-input",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["name",{rules:[{required:!0,message:"请输入围栏名称"}]}],expression:"[\n              'name',\n              {\n                rules: [\n                  {\n                    required: true,\n                    message: '请输入围栏名称',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],attrs:{placeholder:"请输入围栏名称"}})],1),a("a-form-item",{attrs:{label:"类别"}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["category",{rules:[{required:!0,message:"请选择类别!"}]}],expression:"[\n              'category',\n              {\n                rules: [\n                  {\n                    required: true,\n                    message: '请选择类别!',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],attrs:{placeholder:"请选择类别",allowClear:""}},e._l(e.dicItems.fence_category,(function(t,s){return a("a-select-option",{key:s,attrs:{value:t.dicValue}},[e._v(" "+e._s(t.dicLabel)+" ")])})),1)],1),"circle"===e.addFenceType?a("a-form-item",{attrs:{label:"半径"}},[a("div",{staticClass:"flex-censta"},[a("a-input-number",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["radius",{rules:[{required:!0,message:"请输入半径"}]}],expression:"[\n                'radius',\n                {\n                  rules: [\n                    {\n                      required: true,\n                      message: '请输入半径',\n                    },\n                  ],\n                },\n              ]",modifiers:{trim:!0}}],staticStyle:{width:"calc(100% - 30px)"},attrs:{min:0,placeholder:"请输入"},on:{change:e.radiusChange}}),a("div",{staticStyle:{"margin-left":"6px",width:"30px"}},[e._v("m")])],1)]):e._e(),a("a-form-item",{attrs:{label:"面积"}},[a("div",{staticClass:"flex-censta"},[a("a-input-number",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["size",{rules:[{required:!1,message:"请输入面积"}]}],expression:"[\n                'size',\n                {\n                  rules: [\n                    {\n                      required: false,\n                      message: '请输入面积',\n                    },\n                  ],\n                },\n              ]",modifiers:{trim:!0}}],staticStyle:{width:"calc(100% - 30px)"},attrs:{min:0,placeholder:"请输入",disabled:""}}),a("div",{staticStyle:{"margin-left":"6px",width:"30px"}},[e._v("km²")])],1)]),a("a-form-item",{attrs:{label:"经度"}},[a("a-input-number",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["longitude",{rules:[{required:!0,message:"请输入经度"}]}],expression:"[\n              'longitude',\n              {\n                rules: [\n                  {\n                    required: true,\n                    message: '请输入经度',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],staticStyle:{width:"100%"},attrs:{min:0,disabled:"",placeholder:"请输入经度"}})],1),a("a-form-item",{attrs:{label:"纬度"}},[a("a-input-number",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["latitude",{rules:[{required:!0,message:"请输入纬度"}]}],expression:"[\n              'latitude',\n              {\n                rules: [\n                  {\n                    required: true,\n                    message: '请输入纬度',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],staticStyle:{width:"100%"},attrs:{min:0,disabled:"",placeholder:"请输入纬度"}})],1),a("a-form-item",{attrs:{label:"详细地址"}},[a("a-auto-complete",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["address",{rules:[{required:!0,message:"请输入详细地址"}]}],expression:"[\n              'address',\n              {\n                rules: [\n                  {\n                    required: true,\n                    message: '请输入详细地址',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],attrs:{"data-source":e.addressList,placeholder:"请输入详细地址"},on:{change:e.changeAddress,select:e.selectAddress}},[a("template",{slot:"dataSource"},e._l(e.addressList,(function(t){return a("a-select-option",{key:t.addressStr},[e._v(e._s(t.addressStr))])})),1)],2)],1),a("a-form-item",{attrs:{label:"备注"}},[a("a-textarea",{directives:[{name:"decorator",rawName:"v-decorator.trim",value:["remark",{rules:[{required:!1,message:"请输入备注"}]}],expression:"[\n              'remark',\n              {\n                rules: [\n                  {\n                    required: false,\n                    message: '请输入备注',\n                  },\n                ],\n              },\n            ]",modifiers:{trim:!0}}],attrs:{placeholder:"请输入备注",allowClear:"",maxLength:200,"auto-size":{minRows:3,maxRows:5}}})],1),a("a-form-item",[a("div",{staticClass:"flex-cenend formBtn"},[a("BLButton",{on:{click:function(t){return e.resetForm()}}},[e._v("重置")]),a("BLButton",{attrs:{type:"primary",loading:e.submitLoading},on:{click:function(t){return e.handleSubmit()}}},[e._v("保存")])],1)])],1)],1):e._e()],1),a("div",{attrs:{slot:"footer"},slot:"footer"},[a("BLButton",{on:{click:e.handleCancel}},[e._v("取消")])],1)])},r=[],i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"BMapFence"},[a("baidu-map",{staticStyle:{height:"700px",width:"100%"},attrs:{center:e.center,zoom:e.zoom,"scroll-wheel-zoom":!0},on:{ready:e.bMapReady,click:e.clickBMap,moveend:e.syncCenterAndZoom,zoomend:e.syncCenterAndZoom}},[a("bm-scale",{attrs:{anchor:"BMAP_ANCHOR_TOP_RIGHT"}}),a("bm-navigation",{attrs:{anchor:"BMAP_ANCHOR_BOTTOM_LEFT"}}),a("bm-city-list",{attrs:{anchor:"BMAP_ANCHOR_TOP_RIGHT"}}),a("bm-boundary",{attrs:{name:"北京市海淀区",strokeWeight:2,strokeColor:"blue"}}),a("bm-control",{staticClass:"bmControl",attrs:{anchor:"BMAP_ANCHOR_TOP_LEFT"}},[a("a-radio-group",{staticClass:"control",attrs:{value:e.addFenceType,"button-style":"solid"},on:{change:e.addFenceTypeChange}},[a("a-radio-button",{attrs:{value:"circle"}},[e._v("圆")]),a("a-radio-button",{attrs:{value:"polygon"}},[e._v("多边形")])],1)],1),e.showCircleCenterMarker?a("bm-marker",{attrs:{position:e.circlePath.center,dragging:!0},on:{dragend:e.dragMarkerCircleEnd}},[e.circlePath.label?a("bm-label",{attrs:{content:e.circlePath.label,labelStyle:{color:"red",fontSize:"16px"},offset:{width:-45,height:-30}}}):e._e()],1):e._e(),e.showPolygonCenterMarker?a("bm-marker",{attrs:{position:e.polygonPath.center,dragging:!0},on:{dragend:e.dragMarkerPolygonEnd}},[e.polygonPath.label?a("bm-label",{attrs:{content:e.polygonPath.label,labelStyle:{color:"red",fontSize:"16px"},offset:{width:-45,height:-30}}}):e._e()],1):e._e(),e.showCircle?a("bm-circle",{attrs:{center:e.circlePath.center,radius:e.circlePath.radius,"stroke-color":"blue","stroke-opacity":.5,"stroke-weight":2,editing:!0},on:{lineupdate:e.updateCirclePath}}):e._e(),e.showPolygon?a("bm-polygon",{attrs:{path:e.polygonPath.path,"stroke-color":"blue","stroke-opacity":.5,"stroke-weight":2,editing:!0},on:{lineupdate:e.updatePolygonPath}}):e._e()],1)],1)},n=[],o=a(82722);function l(e){const t=Number(e);return isNaN(t)?0:t}var c=a(89467),d={name:"BMapFence",data(){return{center:{lng:114.162508,lat:22.661813},zoom:11,circlePath:{center:{lng:void 0,lat:void 0},radius:void 0,area:void 0,label:void 0},addFenceType:"",polygonPath:{path:[],center:{lng:void 0,lat:void 0},area:void 0,label:void 0},currentCenter:{lng:114.162508,lat:22.661813},BMap:null,map:null,keyword:"",calcAreaSize:0}},computed:{showCircleCenterMarker(){const{center:e}=this.circlePath;return"circle"===this.addFenceType&&e.lng&&e.lat},showPolygonCenterMarker(){const{center:e,path:t}=this.polygonPath;return this.showPolygon&&e.lng&&e.lat&&t.length>2},showCircle(){const{radius:e}=this.circlePath;return this.showCircleCenterMarker&&e},showPolygon(){return"polygon"===this.addFenceType&&this.polygonPath.path&&this.polygonPath.path.length}},methods:{bMapReady({BMap:e,map:t}){this.BMap=e,this.map=t},clickBMap(e){c.log("点击BMap",e);const{lat:t,lng:a}=e.point;if("circle"===this.addFenceType){if(this.resetPolygonData(),!this.circlePath.center.lng||!this.circlePath.center.lat){this.circlePath.center.lng=a,this.circlePath.center.lat=t,this.circlePath.radius=5e3,this.zoom=15,this.center={lng:a,lat:t};const s=this.calcCircleAreaSize(5e3);c.log("circleAreaSize123123",s),this.circlePath.area=s,this.getAddressInfoByLocation(e.point,"circle")}}else"polygon"===this.addFenceType&&(this.resetCircleData(),this.polygonPath.path.push({lng:a,lat:t}),this.polygonPath.path.length>2&&this.calcPolygonAreaSize(),this.postMessageFun())},postMessageFun(){const e={addFenceType:this.addFenceType,circlePath:this.circlePath,polygonPath:this.polygonPath};c.log("发送消息",e),this.$emit("postMessage",e)},resetCircleData(){this.circlePath.center.lng=void 0,this.circlePath.center.lat=void 0,this.circlePath.radius=void 0,this.circlePath.area=void 0,this.circlePath.label=void 0},resetPolygonData(){this.polygonPath.path=[],this.polygonPath.center.lng=void 0,this.polygonPath.center.lat=void 0,this.polygonPath.area=void 0,this.polygonPath.label=void 0},calcCircleAreaSize(e){const t=l(e);return t>0?Math.ceil(Math.PI*t*t):0},calcPolygonAreaSize(){const e=this.polygonPath.path.map((e=>[e.lng,e.lat])),t=[...e,e[0]];var a=turf.polygon([t]),s=turf.area(a),r=turf.centerOfMass(a);const i=r.geometry.coordinates;if(i&&2===i.length){const[e,t]=i;this.polygonPath.center.lng=e,this.polygonPath.center.lat=t;const a=new this.BMap.Point(e,t);this.getAddressInfoByLocation(a,"polygon")}this.polygonPath.area=Math.ceil(s/1e3)},syncCenterAndZoom(e){c.log("移动或缩放时",e),e.target&&e.target.re&&(this.currentCenter.lng=e.target.re.lng,this.currentCenter.lat=e.target.re.lat)},addFenceTypeFun(e){c.log("添加围栏类型",e),this.addFenceType=e},addFenceTypeChange(e){c.log("添加围栏类型12",e);const t=e.target.value;this.addFenceType=t,setTimeout((()=>{this.resetPolygonData(),this.resetCircleData(),this.postMessageFun()}))},updateCirclePath:(0,o.debounce)((function(e){c.log("更新圆形覆盖物",e);const t=e.target.getCenter(),a=e.target.getRadius();c.log("centerLocation123123",t),this.circlePath.center.lng=t.lng,this.circlePath.center.lat=t.lat;const s=Math.ceil(a);this.circlePath.radius=s,this.circlePath.area=this.calcCircleAreaSize(s),this.postMessageFun()}),150),updatePolygonPath(e){c.log("更新矩形覆盖物的路径",e),this.polygonPath.path=e.target.getPath(),this.calcPolygonAreaSize(),this.postMessageFun()},dragMarkerCircleEnd:(0,o.debounce)((function(e){c.log("拖拽marker",e),this.circlePath.center.lng=e.point.lng,this.circlePath.center.lat=e.point.lat,this.getAddressInfoByLocation(e.point,"circle")}),100),dragMarkerPolygonEnd:(0,o.debounce)((function(e){c.log("拖拽marker",e),this.polygonPath.center.lng=e.point.lng,this.polygonPath.center.lat=e.point.lat,this.getAddressInfoByLocation(e.point,"polygon")}),100),getAddressInfoByLocation(e,t){const a=this,s=new a.BMap.Geocoder;s.getLocation(e,(e=>{c.log("reererre",e);const s=e.address;"circle"===t?a.circlePath.label=s:a.polygonPath.label=s,this.postMessageFun()}))},searchcompleteFun(e){c.log("搜索完成方法",e)},changeFenceParams(e){c.log("更改参数",e);const{addFenceType:t,circlePath:a,polygonPath:s}=e;if(this.addFenceType=t,"circle"===t){const{label:e,radius:t,center:s}=a;if(this.circlePath.radius=t,this.circlePath.label=e,s&&s.lat&&s.lng){const{lng:e,lat:a}=s;this.circlePath.center.lng=e,this.circlePath.center.lat=a;const r=this.calcCircleAreaSize(t);this.circlePath.area=r,setTimeout((()=>{this.map.centerAndZoom(new this.BMap.Point(e,a),13)}),300)}}else if("polygon"===t){const{path:e,center:t,label:a}=s;if(Array.isArray(e)&&e.length&&(this.polygonPath.path=e),t&&t.lat&&t.lng){const{lng:e,lat:a}=t;this.polygonPath.center.lng=e,this.polygonPath.center.lat=a,setTimeout((()=>{this.map.centerAndZoom(new this.BMap.Point(e,a),13)}),300)}this.polygonPath.label=a}else this.addFenceType="",this.resetPolygonData(),this.resetCircleData()},getAddressListByKeyword(e){return new Promise((t=>{if(c.log("通过关键词获取搜素下拉列表",e),e){const a=this;c.log("keyword123123123",e),c.log("keyword123123123",this.BMap);const s=new a.BMap.LocalSearch(a.map,{autoViewport:!0});s.search(e),s.setSearchCompleteCallback((function(e){c.log("setSearchCompleteCallback",e),t(e.as||[])}))}else t([])}))}}},h=d,g=a(15627),p=(0,g.A)(h,i,n,!1,null,null,null),u=p.exports,m=a(95932),y=a(89467),P={name:"AddFenceDialog",components:{BMapFence:u},props:{visible:{type:Boolean,default:!1},rowInfo:{type:Object,default(){return{}}}},data(){return{addFenceType:"",polygonPath:[],submitLoading:!1,isLoadDicItems:!1,addAddressOptions:[],dicItems:{fence_category:[]},editId:"",type:1,iframeKey:null,iframeSrc:"http://tms-uat.dekuncn.com:5013/#/dkwlMap",addressList:[]}},watch:{visible(e){e?this.initModal():(this.addFenceType="",this.$refs.BMapFenceRef.changeFenceParams({addFenceType:void 0,circlePath:{center:{lng:void 0,lat:void 0},radius:void 0,label:void 0},polygonPath:{path:[],center:{lng:void 0,lat:void 0},label:void 0}}),this.editId="",this.form.resetFields())}},beforeCreate(){this.form=this.$form.createForm(this,{name:"AddFenceDialog"})},methods:{initModal(){y.log("初始化modal"),this.getDicItems(),this.rowInfo&&this.rowInfo.id&&this.echoForm()},postMessage(e){y.log("发送消息123",e);const{addFenceType:t,circlePath:a,polygonPath:s}=e;if(this.addFenceType=t,"circle"===t)this.form.setFieldsValue({longitude:a.center.lng,latitude:a.center.lat,radius:a.radius,size:a.area,address:a.label});else if("polygon"===t){const e=s.path.map((e=>({lon:e.lng,lat:e.lat})));this.form.setFieldsValue({longitude:s.center.lng,latitude:s.center.lat,size:s.area,address:s.label}),this.polygonPath=e}},async getDicItems(){const e={1:[]},t=Object.keys(e).join(","),a=await(0,m.O_)(t),s=a?.data||[];y.log("resData1231231",s),s.forEach((t=>{t.dicBindId&&e[t.dicBindId].push(t)})),this.dicItems.fence_category=e["1"]},echoForm(){y.log("回显表单",this.rowInfo),this.$nextTick((()=>{const e=this.rowInfo;this.editId=e.id,this.type=e.type,this.addFenceType=1==e.type?"circle":"polygon";const{longitude:t,latitude:a}=e,s=Number(t),r=Number(a);this.$nextTick((()=>{this.form.setFieldsValue({name:e.name,category:String(e.category),radius:e.radius,size:e.size,longitude:s,latitude:r,address:e.address,remark:e.remark,type:e.type}),this.$nextTick((()=>{let t=[];if(e.dispatchAreaCoordinates){const a=JSON.parse(e.dispatchAreaCoordinates);Array.isArray(a)&&a.length&&(t=a.map((e=>({lng:e.lon,...e}))))}this.$refs.BMapFenceRef.changeFenceParams({addFenceType:this.addFenceType,circlePath:{center:{lng:s,lat:r},radius:e.radius,label:e.address},polygonPath:{path:t,center:{lng:s,lat:r},label:e.address}})}))}))}))},handleCancel(){this.$emit("update:visible",!1)},radiusChange(e){y.log("半径=====》",e),this.$nextTick((()=>{this.postMessageToParent()}))},changeAddress:(0,o.debounce)((async function(e){y.log("更改详细地址",e);const t=await this.$refs.BMapFenceRef.getAddressListByKeyword(e);y.log("addressList123123123123",t);const a=[],s=[];t.forEach((e=>{const t=e.address+e.title;a.includes(t)||(a.push(t),e.addressStr=t,s.push(e))})),this.addressList=s,setTimeout((()=>{this.postMessageToParent()}),500)}),350),selectAddress(e){y.log("选中=====>",e),this.form.setFieldsValue({address:e})},postMessageToParent(){if(this.addFenceType){const{radius:e,address:t,lon:a,lat:s}=this.form.getFieldsValue(["radius","address"]),r={addFenceType:this.addFenceType,circlePath:{center:{lng:a,lat:s},radius:void 0,label:t},polygonPath:{path:[],center:{lng:a,lat:s},label:t}};let i=null;this.addressList&&this.addressList.length&&(i=this.addressList.find((e=>e.addressStr===t))),y.log("findAddressitem123123123",i),"circle"===this.addFenceType?(i&&i.point&&(r.circlePath.center.lng=i.point.lng,r.circlePath.center.lat=i.point.lat),r.circlePath.radius=e,r.circlePath.label=t):"polygon"===this.addFenceType&&(r.polygonPath.label=t),this.$refs.BMapFenceRef.changeFenceParams(r)}},handleSubmit(){y.log("表单提交"),this.form.validateFields(((e,t)=>{if(!e){y.log("表单提交数据",t);const e={type:"polygon"===this.addFenceType?2:1,...t};"polygon"===this.addFenceType&&(e.dispatchAreaCoordinates=JSON.stringify(this.polygonPath)),this.editId?(e.id=this.editId,this.editFenceFun(e)):this.addFenceFun(e)}}))},resetForm(){this.form.resetFields()},addFenceFun(e){this.submitLoading=!0,(0,m.xz)(e).then((e=>{200===e.code?(this.$message.success("新增电子围栏成功"),this.handleCancel(),this.$emit("success")):this.$message.error(e.message||"请求错误")})).finally((()=>{this.submitLoading=!1}))},editFenceFun(e){this.submitLoading=!0,(0,m.Wc)(e).then((e=>{200===e.code?(this.$message.success("编辑电子围栏成功"),this.handleCancel(),this.$emit("success")):this.$message.error(e.message||"请求错误")})).finally((()=>{this.submitLoading=!1}))}}},f=P,b=(0,g.A)(f,s,r,!1,null,"3085e7db",null),v=b.exports}}]);
//# sourceMappingURL=477.74dfff44.js.map